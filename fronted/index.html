<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="UTF-8">
        <title>Modbus Fuzzing Lab</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="/socket.io/socket.io.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=JetBrains+Mono:wght@400;700&display=swap"
              rel="stylesheet">
        <style>
                body {
                        background: #0d1117;
                        color: #c9d1d9;
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 16px;
                }

                .lab-title {
                        font-family: "Orbitron", sans-serif;
                        font-size: 24px;
                        font-weight: 900;
                        letter-spacing: 0.2em;
                        color: #f0f6fc;
                }

                .lab-title span {
                        color: #58a6ff;
                }

                .dot {
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 10px;
                        vertical-align: middle;
                }

                .dot-running {
                        background-color: #23d160;
                        box-shadow: 0 0 12px #23d160;
                        animation: dot-breathe 2s infinite ease-in-out;
                }

                .dot-starting {
                        background-color: #f1c40f;
                        box-shadow: 0 0 12px #f1c40f;
                        animation: fast-blink 0.6s infinite ease-in-out;
                }

                .dot-crashed {
                        background-color: #f85149;
                        box-shadow: 0 0 12px #f85149;
                }

                @keyframes dot-breathe {
                        0%, 100% {
                                opacity: 1;
                                transform: scale(1);
                        }
                        50% {
                                opacity: 0.5;
                                transform: scale(0.9);
                        }
                }

                @keyframes fast-blink {
                        0%, 100% {
                                opacity: 1;
                        }
                        50% {
                                opacity: 0.3;
                        }
                }

                .text-glow-green {
                        color: #23d160;
                        text-shadow: 0 0 8px rgba(35, 209, 96, 0.5), 0 0 15px rgba(35, 209, 96, 0.2);
                        animation: text-breathe-green 2.5s infinite ease-in-out;
                }

                .text-glow-red {
                        color: #f85149;
                        text-shadow: 0 0 8px rgba(248, 81, 73, 0.6), 0 0 15px rgba(248, 81, 73, 0.2);
                }

                .text-glow-yellow {
                        color: #f1c40f;
                        text-shadow: 0 0 8px rgba(241, 196, 15, 0.5);
                }

                @keyframes text-breathe-green {
                        0%, 100% {
                                text-shadow: 0 0 6px rgba(35, 209, 96, 0.4);
                                opacity: 1;
                        }
                        50% {
                                text-shadow: 0 0 15px rgba(35, 209, 96, 0.8), 0 0 25px rgba(35, 209, 96, 0.3);
                                opacity: 0.9;
                        }
                }

                .packet-row {
                        display: flex;
                        align-items: center;
                        position: relative;
                        padding: 8px 12px;
                        transition: all 0.3s;
                }

                .packet-row.crash-trigger {
                        background: linear-gradient(90deg, rgba(248, 81, 73, 0.25) 0%, transparent 100%) !important;
                        border-left: 4px solid #f85149 !important;
                        animation: crash-shake 0.4s ease-in-out;
                }

                .crash-tag {
                        margin-left: auto;
                        background: #f85149;
                        color: white;
                        font-size: 10px;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-weight: bold;
                        box-shadow: 0 0 15px rgba(248, 81, 73, 0.8);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        white-space: nowrap;
                        animation: tag-glow 1s infinite alternate;
                }

                @keyframes tag-glow {
                        from {
                                box-shadow: 0 0 5px #f85149;
                                transform: scale(1);
                        }
                        to {
                                box-shadow: 0 0 15px #f85149;
                                transform: scale(1.05);
                        }
                }

                @keyframes crash-shake {
                        0%, 100% {
                                transform: translateX(0);
                        }
                        20% {
                                transform: translateX(-8px);
                        }
                        40% {
                                transform: translateX(8px);
                        }
                        60% {
                                transform: translateX(-4px);
                        }
                        80% {
                                transform: translateX(4px);
                        }
                }

                .archive-row {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 10px;
                        background: rgba(255, 255, 255, 0.02);
                        border: 1px solid rgba(255, 255, 255, 0.05);
                        border-radius: 4px;
                }

                .tag-blocked {
                        background: #238636;
                        color: white;
                        font-size: 9px;
                        padding: 1px 6px;
                        border-radius: 3px;
                        font-weight: bold;
                }

                .tag-fatal {
                        background: #f85149;
                        color: white;
                        font-size: 9px;
                        padding: 1px 6px;
                        border-radius: 3px;
                        font-weight: bold;
                        box-shadow: 0 0 10px rgba(248, 81, 73, 0.4);
                }

                .b-trans {
                        color: #58a6ff;
                        font-weight: bold;
                }

                .b-len {
                        color: #d29922;
                        font-weight: bold;
                }

                .b-unit {
                        color: #f85149;
                        font-weight: bold;
                }

                .b-func {
                        color: #3fb950;
                        font-weight: bold;
                        border-bottom: 2px solid rgba(63, 185, 80, 0.4);
                }

                .b-data {
                        color: #8b949e;
                }

                .legend-item {
                        font-size: 11px;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                }

                .btn-restart {
                        background: #1f6feb;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        color: white;
                        padding: 6px 20px;
                        border-radius: 6px;
                        font-weight: bold;
                        transition: all 0.2s;
                        box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
                        cursor: pointer;
                }

                .btn-restart:hover {
                        background: #388bfd;
                        box-shadow: 0 0 15px rgba(56, 139, 253, 0.5);
                }

                .btn-clear {
                        font-size: 10px;
                        color: #8b949e;
                        border: 1px solid #30363d;
                        padding: 2px 8px;
                        border-radius: 4px;
                        transition: all 0.2s;
                        cursor: pointer;
                        background: transparent;
                }

                .btn-clear:hover {
                        background: #30363d;
                        color: #f0f6fc;
                }

                .btn-pause {
                        border-color: #d29922;
                        color: #d29922;
                }

                .btn-pause.paused {
                        background: #d29922;
                        color: #0d1117;
                        font-weight: bold;
                }

                .panel {
                        background: #161b22;
                        border: 1px solid #30363d;
                        border-radius: 6px;
                }

                .toggle {
                        width: 40px;
                        height: 20px;
                        background: #30363d;
                        border-radius: 10px;
                        position: relative;
                        cursor: pointer;
                        transition: 0.2s;
                }

                .toggle::after {
                        content: '';
                        position: absolute;
                        width: 14px;
                        height: 14px;
                        top: 3px;
                        left: 3px;
                        background: #8b949e;
                        border-radius: 50%;
                        transition: 0.2s;
                }

                .toggle.on {
                        background: #238636;
                }

                .toggle.on::after {
                        left: 23px;
                        background: #fff;
                }

                ::-webkit-scrollbar {
                        width: 5px;
                }

                ::-webkit-scrollbar-thumb {
                        background: #30363d;
                        border-radius: 5px;
                }
        </style>
</head>
<body class="p-8">
<div class="max-w-5xl mx-auto">

        <div class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
                <div class="lab-title">Modbus <span>Fuzzing Lab</span></div>
                <button onclick="restartService()" class="btn-restart uppercase text-sm tracking-widest">Restart
                </button>
        </div>

        <div class="bg-[#010409] p-4 border border-[#30363d] rounded-md mb-8 flex justify-between items-center shadow-inner">
                <div class="text-sm">
                        运行状态: <span id="dot" class="dot dot-running"></span>
                        <span id="status-text" class="text-glow-green font-bold uppercase">active (running)</span>
                </div>
                <div class="text-[10px] text-slate-500">Target IP: 127.0.0.1 | Port: 5020</div>
        </div>

        <div class="grid grid-cols-4 gap-6">
                <div class="col-span-1 space-y-4">
                        <div class="panel p-4">
                                <h3 class="text-[10px] text-slate-500 font-bold uppercase mb-4 tracking-tighter">
                                        安全防御策略</h3>
                                <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-300">长度攻击防护</span>
                                                <div id="swLength" onclick="toggle('Length')" class="toggle"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-300">功能码拦截</span>
                                                <div id="swFuncCode" onclick="toggle('FuncCode')" class="toggle"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-300">超大负载限制</span>
                                                <div id="swPayload" onclick="toggle('Payload')" class="toggle"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-300">格式匹配校验</span>
                                                <div id="swFormat" onclick="toggle('Format')" class="toggle"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-300">业务逻辑边界</span>
                                                <div id="swBoundary" onclick="toggle('Boundary')" class="toggle"></div>
                                        </div>
                                </div>
                        </div>
                </div>

                <div class="col-span-3">
                        <div class="panel flex flex-col h-[650px] overflow-hidden shadow-2xl">
                                <div class="flex justify-between items-center p-3 bg-black/20 border-b border-[#30363d]">
                                        <div class="flex gap-4">
                                                <div class="legend-item"><span class="b-trans">■</span>Trans/Proto</div>
                                                <div class="legend-item"><span class="b-len">■</span>Length</div>
                                                <div class="legend-item"><span class="b-unit">■</span>Unit</div>
                                                <div class="legend-item"><span class="b-func">■</span>Func</div>
                                                <div class="legend-item"><span class="b-data">■</span>Data</div>
                                        </div>
                                        <div class="flex gap-2">
                                                <button id="btnPause" onclick="togglePause()"
                                                        class="btn-clear btn-pause">PAUSE STREAM
                                                </button>
                                                <button onclick="clearPackets()" class="btn-clear">CLEAR DATA</button>
                                        </div>
                                </div>

                                <div id="packet-list" class="flex-1 overflow-y-auto p-4 space-y-1"></div>

                                <div class="panel flex flex-col h-[200px] mt-6 border-red-900/30 shadow-[0_0_20px_rgba(248,81,73,0.05)]">
                                        <div class="flex justify-between items-center p-3 bg-red-900/10 border-b border-[#30363d]">
                                                <div class="flex items-center gap-2">
                                                        <span class="flex h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
                                                        <span class="text-[10px] font-bold text-red-400 uppercase tracking-widest">安全事件归档</span>
                                                </div>
                                                <button onclick="clearArchive()"
                                                        class="btn-clear text-red-400 border-red-900/50 hover:bg-red-900/20">
                                                        CLEAR ARCHIVE
                                                </button>
                                        </div>
                                        <div id="archive-list"
                                             class="flex-1 overflow-y-auto p-4 space-y-2 custom-scroll bg-[#0d1117]">
                                                <div class="text-slate-600 text-[10px] italic text-center mt-10">
                                                        等待捕获异常安全事件...
                                                </div>
                                        </div>
                                </div>

                                <div class="bg-black/40 border-t border-[#30363d] flex flex-col h-40">
                                        <div class="px-3 py-1 flex justify-between items-center border-b border-[#30363d]/50">
                                                <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Journal Logs</span>
                                                <button onclick="clearLogs()" class="btn-clear"
                                                        style="padding: 0px 5px; font-size: 8px;">CLEAR
                                                </button>
                                        </div>
                                        <div id="logs"
                                             class="flex-1 p-3 text-[11px] font-mono overflow-y-auto space-y-1">
                                                <div class="text-slate-500">> System journal initialized.</div>
                                        </div>
                                </div>
                        </div>
                </div>
        </div>
</div>

<script>
        const socket = io();
        let config = {
                protectLength: false,
                protectFuncCode: false,
                protectPayload: false,
                protectFormat: false,
                protectBoundary: false
        };
        let isPaused = false;

        // 重启
        function restartService() {
                const dot = document.getElementById('dot');
                const text = document.getElementById('status-text');
                dot.className = "dot dot-starting";
                text.innerText = "activating (starting)";
                text.className = "text-glow-yellow font-bold uppercase";

                socket.emit('restart');
                addLog("RESTART signal sent. Initializing new process...");
        }

        // 防御切换
        function toggle(type) {
                config[`protect${type}`] = !config[`protect${type}`];
                document.getElementById(`sw${type}`).classList.toggle('on', config[`protect${type}`]);
                socket.emit('toggleProtect', config);
        }

        // 界面控制
        function togglePause() {
                isPaused = !isPaused;
                const btn = document.getElementById('btnPause');
                btn.innerText = isPaused ? "RESUME STREAM" : "PAUSE STREAM";
                btn.classList.toggle('paused', isPaused);
        }

        function clearPackets() {
                document.getElementById('packet-list').innerHTML = '';
        }

        function clearLogs() {
                document.getElementById('logs').innerHTML = '<div class="text-slate-500">> Logs cleared.</div>';
        }

        // 报文高亮
        function highlight(hex) {
                let b = hex.match(/.{1,2}/g);
                if (!b || b.length < 8) return `<span class="text-slate-600">${hex}</span>`;
                return b.map((v, i) => {
                        let c = 'b-data';
                        if (i < 4) c = 'b-trans';
                        else if (i < 6) c = 'b-len';
                        else if (i === 6) c = 'b-unit';
                        else if (i === 7) c = 'b-func';
                        return `<span class="${c}">${v}</span>`;
                }).join(' ');
        }

        socket.on('newPacket', (pkt) => {
                if (isPaused) return;
                const list = document.getElementById('packet-list');
                const div = document.createElement('div');
                div.className = "py-1 flex gap-6 text-[16px] tracking-widest border-b border-white/5 hover:bg-white/5 transition-colors rounded";
                div.innerHTML = `<span class="text-slate-600 text-[10px] w-20 pt-1">${pkt.time}</span><span class="flex-1">${highlight(pkt.raw)}</span>`;
                list.prepend(div);
                if (list.children.length > 100) list.lastChild.remove();
        });

        socket.on('statusUpdate', (data) => {
                const isRun = data.status === 'RUNNING';
                const dot = document.getElementById('dot');
                const text = document.getElementById('status-text');

                // 更新状态文字和灯光
                dot.className = `dot ${isRun ? 'dot-running' : 'dot-crashed'}`;
                text.innerText = isRun ? 'active (running)' : 'failed (crashed)';
                text.className = isRun ? 'text-glow-green font-bold uppercase' : 'text-glow-red font-bold uppercase';

                // --- 标记崩溃报文逻辑 ---
                if (data.status === 'CRASHED') {
                        const list = document.getElementById('packet-list');
                        // 获取当前列表中最上面的一行
                        const killerPacket = list.firstElementChild;

                        if (killerPacket && !killerPacket.querySelector('.crash-tag')) {
                                killerPacket.classList.add('crash-trigger');

                                // 创建警示标签
                                const tag = document.createElement('span');
                                tag.className = 'crash-tag';
                                tag.innerText = 'Fatal Payload';

                                // 将标签直接添加到行容器内部，flex 布局会自动处理位置
                                killerPacket.appendChild(tag);
                        }
                }
        });

        socket.on('log', (msg) => {
                let type = 'INFO';
                const uMsg = msg.toUpperCase();
                if (uMsg.includes('FATAL') || uMsg.includes('ERROR')) type = 'ERROR';
                else if (uMsg.includes('BLOCKED') || uMsg.includes('READY') || uMsg.includes('SUCCESS')) type = 'SUCCESS';
                addLog(msg, type);
        });

        function addLog(msg, type = 'INFO') {
                const el = document.getElementById('logs');
                const div = document.createElement('div');
                div.className = "py-0.5 border-b border-white/5";
                if (type === 'ERROR') div.classList.add("text-red-500", "font-bold");
                else if (type === 'SUCCESS') div.classList.add("text-green-500");
                else div.classList.add("text-slate-500");

                div.innerHTML = `[${new Date().toLocaleTimeString()}] > ${msg}`;
                el.appendChild(div);
                el.scrollTop = el.scrollHeight;
                if (el.children.length > 100) el.removeChild(el.firstChild);
        }

        let currentLastPacket = null; // 记录最近收到的报文

        // 修改 newPacket 监听
        socket.on('newPacket', (pkt) => {
                currentLastPacket = pkt;

                if (isPaused) return;
        });

        // 归档
        function addToArchive(pkt, type) {
                if (!pkt) return;
                const list = document.getElementById('archive-list');

                // 如果是第一次添加，清空提示文字
                if (list.querySelector('.italic')) list.innerHTML = '';

                const div = document.createElement('div');
                div.className = "archive-row animate-fade-in";

                const tagClass = type === 'FATAL' ? 'tag-fatal' : 'tag-blocked';
                const tagName = type === 'FATAL' ? 'CRASH_TRIGGER' : 'INTERCEPTED';

                div.innerHTML = `
        <span class="text-slate-600 text-[10px] w-16">${pkt.time}</span>
        <span class="${tagClass}">${tagName}</span>
        <span class="flex-1 tracking-widest text-[14px]">${highlight(pkt.raw)}</span>
    `;

                list.prepend(div);
        }

        socket.on('log', (msg) => {
                if (msg.includes('Blocked')) {
                        addToArchive(currentLastPacket, 'BLOCKED');
                }
        });

        socket.on('statusUpdate', (data) => {
                if (data.status === 'CRASHED') {
                        addToArchive(currentLastPacket, 'FATAL');
                        markMainStreamCrash();
                }
        });

        // 清除归档
        function clearArchive() {
                document.getElementById('archive-list').innerHTML = '<div class="text-slate-600 text-[10px] italic text-center mt-10">Archive cleared.</div>';
        }
</script>
</body>
</html>
